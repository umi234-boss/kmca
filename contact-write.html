<!-- =============================
     /contact-write.html (찾아보기_문의하기 글쓰기)
     ============================= -->
<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>문의 글쓰기 — 신한국손해사정(주)</title>
    <link rel="stylesheet" href="assets/style.css" />
    <link rel="stylesheet" href="assets/header.css" />
    <script defer src="assets/app.js" data-base="/kmca/"></script>
    <style>
      .contact-write {
        background: #f5f7ff;
        min-height: calc(100vh - 340px);
        padding: 80px 0 120px;
      }
      .contact-write__panel {
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 28px 64px rgba(15, 23, 66, 0.08);
        padding: 48px;
        max-width: 820px;
        margin: 0 auto;
        border: 1px solid #dbe3f5;
      }
      .contact-write__title {
        margin: 0 0 16px;
        font-size: 32px;
        font-weight: 800;
        color: #132a6b;
        text-align: center;
      }
      .contact-write__desc {
        text-align: center;
        margin: 0 0 36px;
        color: #475569;
        font-size: 15px;
        line-height: 1.7;
      }
      .contact-write__summary {
        background: rgba(19, 42, 107, 0.08);
        border-radius: 14px;
        padding: 16px 20px;
        margin-bottom: 30px;
        font-size: 14px;
        color: #1f2a44;
        display: flex;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
      }
      .contact-write__summary span {
        font-weight: 700;
      }
      .contact-write__form {
        display: grid;
        gap: 24px;
      }
      .contact-write__field {
        display: grid;
        gap: 10px;
      }
      .contact-write__label {
        font-size: 15px;
        font-weight: 700;
        color: #1f2a44;
      }
      .contact-write__select,
      .contact-write__input,
      .contact-write__textarea {
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(19, 42, 107, 0.2);
        padding: 14px 16px;
        font-size: 15px;
        color: #0f172a;
        font-family: inherit;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        background: #fff;
      }
      .contact-write__textarea {
        min-height: 360px;
        resize: vertical;
        line-height: 1.7;
      }
      .contact-write__select:focus,
      .contact-write__input:focus,
      .contact-write__textarea:focus {
        border-color: #1d4ed8;
        box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.2);
        outline: none;
      }
      .contact-write__controls {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        flex-wrap: wrap;
      }
      .contact-write__button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 26px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 15px;
        cursor: pointer;
        border: none;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .contact-write__button--ghost {
        background: #f1f5ff;
        color: #1f2a44;
        border: 1px solid rgba(19, 42, 107, 0.15);
      }
      .contact-write__button--primary {
        background: #1d4ed8;
        color: #fff;
        box-shadow: 0 10px 24px rgba(29, 78, 216, 0.18);
      }
      .contact-write__button:hover {
        transform: translateY(-1px);
      }
      .contact-write__button:active {
        transform: translateY(0);
      }
      .contact-write__note {
        font-size: 13px;
        color: #475569;
        line-height: 1.7;
        background: rgba(148, 163, 184, 0.2);
        border-radius: 12px;
        padding: 16px 18px;
      }
      .contact-write__shortcut {
        font-size: 14px;
        color: #0b1f6b;
        text-align: right;
        margin: 18px 0 0;
      }
      @media (max-width: 760px) {
        .contact-write {
          padding: 48px 0 80px;
        }
        .contact-write__panel {
          padding: 32px 24px;
        }
        .contact-write__controls {
          flex-direction: column-reverse;
          align-items: stretch;
        }
        .contact-write__button {
          width: 100%;
        }
        .contact-write__summary {
          flex-direction: column;
          gap: 10px;
        }
      }
      @media (max-width: 540px) {
        .contact-write__panel {
          padding: 28px 20px;
        }
        .contact-write__title {
          font-size: 28px;
        }
        .contact-write__textarea {
          min-height: 240px;
        }
        .contact-write__summary {
          font-size: 13px;
        }
      }
    </style>
  </head>
  <body data-header-mode="solid">
    <div id="site-header"></div>
    <main class="contact-write">
      <div class="container">
        <article class="contact-write__panel">
          <h1 class="contact-write__title">문의 글쓰기</h1>
          <p class="contact-write__desc">
            문의 내용을 정확하게 작성해주시면 담당 손해사정사가 빠르게 확인 후 연락드립니다.
            작성 완료 후에는 목록에서 비밀번호로 본문 확인 및 삭제가 가능합니다.
          </p>
          <div class="contact-write__summary" id="contactWriteSummary" hidden></div>
          <form class="contact-write__form" id="contactWriteForm">
            <div class="contact-write__field">
              <label class="contact-write__label" for="contactCategory">카테고리</label>
              <select
                id="contactCategory"
                class="contact-write__select"
                name="category"
                required
              >
                <option value="insurer">피보험자(보험사)</option>
                <option value="victim">피해자</option>
              </select>
            </div>
            <div class="contact-write__field">
              <label class="contact-write__label" for="contactTitleInput">제목</label>
              <input
                type="text"
                id="contactTitleInput"
                class="contact-write__input"
                name="title"
                placeholder="문의 제목을 입력하세요."
                required
              />
            </div>
            <div class="contact-write__field">
              <label class="contact-write__label" for="contactBody">본문</label>
              <textarea
                id="contactBody"
                class="contact-write__textarea"
                name="body"
                required
              ></textarea>
              <p class="contact-write__note">
                문의 하신 후에는 반드시 <strong>kmca234@naver.com</strong> 메일로 이름, 제목, 비밀번호를 남겨주세요.
                담당자가 확인 후 답변 및 연락을 드립니다.
              </p>
            </div>
            <div class="contact-write__controls">
              <button
                type="button"
                class="contact-write__button contact-write__button--ghost"
                id="contactWriteCancel"
              >
                목록으로
              </button>
              <button
                type="submit"
                class="contact-write__button contact-write__button--primary"
              >
                등록
              </button>
            </div>
          </form>
          <p class="contact-write__shortcut">
            문의 목록으로 돌아가시려면 <a href="contact.html">여기를 클릭</a>하세요.
          </p>
        </article>
      </div>
    </main>
    <div id="site-footer"></div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const AUTH_SESSION_KEY = "kmcaContactAuth";
        const TEMPLATE_TEXT = [
          '문의 하기 등록 하신 분은 반드시 "kmca234@naver.com" 메일로 이름/제목/비밀번호를 남기셔야 답변 및 연락을 드릴수 있습니다.',
          "",
          "",
          "* 하기 양식으로 작성 부탁드리며, 상담시 필요한 사항은 따로 문의할 수 있는 점 참고부탁드립니다.",
          "",
          "[ 모르는 부분은 \"모름\" 이나 빈칸으로 남겨주시면 따로 문의드리겠습니다. ]",
          "",
          "",
          "1. 가/피해자 여부 :",
          "",
          "2. 자동차 사고여부(Y/N):",
          "",
          "3. 보험사 - 본인 :",
          "               - 상대방 :",
          "",
          "4. 과실확정여부 :      %",
          "    (본인과실에 대해 기재 부탁드립니다.)",
          "",
          "5. 사고 경위 :",
          "",
          "6. 문의내용 :",
        ].join("\n");

        const categoryLabelMap = {
          insurer: "피보험자(보험사)",
          victim: "피해자",
        };

        const form = document.getElementById("contactWriteForm");
        const summary = document.getElementById("contactWriteSummary");
        const bodyInput = document.getElementById("contactBody");
        const cancelBtn = document.getElementById("contactWriteCancel");

        const authRaw = sessionStorage.getItem(AUTH_SESSION_KEY);
        if (!authRaw) {
          alert("문의 작성 권한이 확인되지 않았습니다. 다시 시도해주세요.");
          window.location.href = "contact.html";
          return;
        }

        let authInfo;
        try {
          authInfo = JSON.parse(authRaw);
        } catch (_) {
          authInfo = null;
        }

        if (!authInfo || !authInfo.name || !authInfo.password) {
          alert("문의 작성 권한이 올바르지 않습니다. 다시 시도해주세요.");
          sessionStorage.removeItem(AUTH_SESSION_KEY);
          window.location.href = "contact.html";
          return;
        }

        if (summary) {
          summary.hidden = false;
          summary.innerHTML = [
            `<span>작성자</span> ${authInfo.name}`,
            `<span>비밀번호</span> ${"*".repeat(Math.max(authInfo.password.length, 4))}`,
          ].join("");
        }

        if (bodyInput && !bodyInput.value) {
          bodyInput.value = TEMPLATE_TEXT;
        }

        const apiBase = (() => {
          const attr = (document.body.getAttribute("data-api-base") || "").trim();
          if (attr) return attr;
          if (
            (location.hostname === "localhost" || location.hostname === "127.0.0.1") &&
            location.port === "5173"
          ) {
            return "http://localhost:5174/api";
          }
          return "/api";
        })();

        function buildApiUrl(path) {
          const base = apiBase.replace(/\/+$/, "");
          const cleanPath = path.startsWith("/") ? path : `/${path}`;
          return `${base}${cleanPath}`;
        }

        async function createEntry(entry) {
          const response = await fetch(buildApiUrl("/contact/entries"), {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify(entry),
          });
          const data = await response.json().catch(() => ({}));
          if (!response.ok || !data.success) {
            if (response.status === 401) {
              throw new Error(
                data && data.error
                  ? data.error
                  : "비밀번호 인증에 실패했습니다. 다시 시도해주세요."
              );
            }
            const message =
              data && data.error ? data.error : `HTTP ${response.status}`;
            throw new Error(message);
          }
          return data.entry;
        }

        if (form) {
          form.addEventListener("submit", function (event) {
            event.preventDefault();
            const categoryValue = form.category.value;
            const title = form.title.value.trim();
            const body = form.body.value.trim();
            if (!title || !body) {
              alert("제목과 본문을 모두 입력해주세요.");
              return;
            }

            const entry = {
              categoryValue,
              categoryLabel: categoryLabelMap[categoryValue] || "미지정",
              title,
              body,
              authorName: authInfo.name,
              password: authInfo.password,
            };

            try {
              await createEntry(entry);
              sessionStorage.removeItem(AUTH_SESSION_KEY);
              alert("문의가 등록되었습니다. 목록에서 확인해주세요.");
              window.location.href = "contact.html";
            } catch (error) {
              console.error("[contact] 문의 등록 실패:", error);
              alert(
                error && error.message
                  ? `문의 등록 중 오류가 발생했습니다.\n사유: ${error.message}`
                  : "문의 등록 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요."
              );
            }
          });
        }

        if (cancelBtn) {
          cancelBtn.addEventListener("click", function () {
            sessionStorage.removeItem(AUTH_SESSION_KEY);
            window.location.href = "contact.html";
          });
        }
      });
    </script>
  </body>
</html>
